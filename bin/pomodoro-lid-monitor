#!/usr/bin/env bash
set -euo pipefail

STATE_FILE="/tmp/pomodoro-state"

stop_pomodoro() {
    if [[ -f "$STATE_FILE" ]]; then
        cat > "$STATE_FILE" <<EOF
phase=idle
remaining=0
paused=0
completed=0
start_time=0
pause_time=0
EOF
        pkill -RTMIN+10 waybar 2>/dev/null || true
    fi
}

gdbus monitor --system --dest org.freedesktop.login1 --object-path /org/freedesktop/login1 2>/dev/null | while read -r line; do
    if [[ "$line" == *"'LidClosed'"*"<true>"* ]]; then
        stop_pomodoro
    fi
done
