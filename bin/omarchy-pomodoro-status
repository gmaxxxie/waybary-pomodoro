#!/usr/bin/env bash
# omarchy-pomodoro-status - Waybar module for Pomodoro timer
# Outputs JSON for waybar custom module

set -euo pipefail

STATE_FILE="/tmp/pomodoro-state"
WORK_DURATION=$((25 * 60))
SHORT_BREAK=$((5 * 60))
LONG_BREAK=$((15 * 60))

# Run tick to check for phase transitions
omarchy-pomodoro tick 2>/dev/null || true

# Read state
if [[ ! -f "$STATE_FILE" ]]; then
    # Idle state - show clickable start icon
    echo '{"text": "üçÖ", "tooltip": "Pomodoro Timer\n\nClick to start\nRight-click to reset", "class": "idle"}'
    exit 0
fi

source "$STATE_FILE"

get_phase_duration() {
    case "$1" in
        work) echo "$WORK_DURATION" ;;
        short_break) echo "$SHORT_BREAK" ;;
        long_break) echo "$LONG_BREAK" ;;
        *) echo 0 ;;
    esac
}

format_time() {
    local seconds="$1"
    if (( seconds < 0 )); then
        seconds=0
    fi
    local mins=$((seconds / 60))
    local secs=$((seconds % 60))
    printf "%02d:%02d" "$mins" "$secs"
}

get_phase_icon() {
    case "$1" in
        work) echo "üçÖ" ;;
        short_break) echo "‚òï" ;;
        long_break) echo "üå¥" ;;
        *) echo "üçÖ" ;;
    esac
}

get_phase_name() {
    case "$1" in
        work) echo "Work" ;;
        short_break) echo "Short Break" ;;
        long_break) echo "Long Break" ;;
        idle) echo "Idle" ;;
        *) echo "Unknown" ;;
    esac
}

# Calculate remaining time
if [[ "$phase" == "idle" ]]; then
    echo '{"text": "üçÖ", "tooltip": "Pomodoro Timer\n\nClick to start\nRight-click to reset", "class": "idle"}'
    exit 0
fi

if [[ "$paused" -eq 1 ]]; then
    # When paused, calculate remaining from when we paused
    elapsed=$((pause_time - start_time))
else
    # When running, calculate from now
    now=$(date +%s)
    elapsed=$((now - start_time))
fi

phase_duration=$(get_phase_duration "$phase")
remaining=$((phase_duration - elapsed))

if (( remaining < 0 )); then
    remaining=0
fi

icon=$(get_phase_icon "$phase")
phase_name=$(get_phase_name "$phase")
time_str=$(format_time "$remaining")

# Build display text
if [[ "$paused" -eq 1 ]]; then
    text="$icon $time_str ‚è∏"
    class="paused"
else
    text="$icon $time_str"
    class="$phase"
fi

# Build tooltip
tooltip="$phase_name - $time_str remaining\n"
tooltip+="Completed: $completed pomodoros\n\n"
tooltip+="Left-click: Start/Pause\n"
tooltip+="Right-click: Stop\n"
tooltip+="Middle-click: Skip"

# Output JSON for waybar
printf '{"text": "%s", "tooltip": "%s", "class": "%s"}\n' "$text" "$tooltip" "$class"
